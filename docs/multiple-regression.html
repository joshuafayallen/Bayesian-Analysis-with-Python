<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; GLM’s and Multiple Regression – Bayesian Analysis with Python: Notebook</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./mlm.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-485d01fc63b59abcd3ee1bf1e8e2748d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./multiple-regression.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">GLM’s and Multiple Regression</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Bayesian Analysis with Python: Notebook</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./thinking-probabilistically.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Thinking Probabilistically</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Programming-Probabilistically.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Programming Probabilistically</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mlm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Hierarchical Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./multiple-regression.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">GLM’s and Multiple Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#ols" id="toc-ols" class="nav-link active" data-scroll-target="#ols"><span class="header-section-number">4.1</span> OLS</a>
  <ul class="collapse">
  <li><a href="#interpreting-model-output" id="toc-interpreting-model-output" class="nav-link" data-scroll-target="#interpreting-model-output"><span class="header-section-number">4.1.1</span> Interpreting Model output</a></li>
  <li><a href="#interpreting-the-posterior-predictions" id="toc-interpreting-the-posterior-predictions" class="nav-link" data-scroll-target="#interpreting-the-posterior-predictions"><span class="header-section-number">4.1.2</span> Interpreting the posterior predictions</a></li>
  </ul></li>
  <li><a href="#glms" id="toc-glms" class="nav-link" data-scroll-target="#glms"><span class="header-section-number">4.2</span> GLMS</a>
  <ul class="collapse">
  <li><a href="#robust-regressions" id="toc-robust-regressions" class="nav-link" data-scroll-target="#robust-regressions"><span class="header-section-number">4.2.1</span> Robust regressions</a></li>
  <li><a href="#logits" id="toc-logits" class="nav-link" data-scroll-target="#logits"><span class="header-section-number">4.2.2</span> Logits</a></li>
  </ul></li>
  <li><a href="#variable-variance" id="toc-variable-variance" class="nav-link" data-scroll-target="#variable-variance"><span class="header-section-number">4.3</span> Variable variance</a></li>
  <li><a href="#hmlm" id="toc-hmlm" class="nav-link" data-scroll-target="#hmlm"><span class="header-section-number">4.4</span> HMLM</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">GLM’s and Multiple Regression</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="a6eb2a93" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars.selectors <span class="im">as</span> cs</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> preliz <span class="im">as</span> pz</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.interpolate <span class="im">import</span> PchipInterpolator</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For the most part we have really just been working in simple simple land. We have only been passing off models that look a bit like</p>
<p><span class="math display">\[
Y = \beta_1 \times var + \varepsilon
\]</span></p>
<p>Some more astute users or just casual viewers may have noticed that we are not specifying a model with an intercept. Which is fine for some things probably not ideal for others! So the big thing about this chapter for me is really just building a simple model with more moving parts into the likelihood and then getting real funky with the likelihood.</p>
<section id="ols" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="ols"><span class="header-section-number">4.1</span> OLS</h2>
<div id="d6e850f6" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>bikes <span class="op">=</span> pl.read_csv(<span class="st">'https://raw.githubusercontent.com/aloctavodia/BAP3/refs/heads/main/code/data/bikes.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So the model is going to look pretty similar just with a little bit of a remix. So <span class="math inline">\(\sigma\)</span> looks the same, for the most part, while the mu changes a bit because you have to tell PyMC what is being multiplied to get the mean of the whatever. So if we are specifying a model of bike rentals with temperature as one of our predictors as in the book. The model would look like this when we write it out mathily.</p>
<p><span class="math display">\[
\begin{aligned}
\alpha \sim Normal(0, 100) \\
\beta \sim Normal(0, 100) \\
\sigma \sim Half Cauchy(10) \\
y \sim Normal(mu, sigma)
\end{aligned}
\]</span></p>
<p>In PyMC there is one additional step to get the correct mu,</p>
<div id="867a08f2" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_ols:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> pm.Normal(<span class="st">'alpha'</span>, <span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> pm.Normal(<span class="st">'beta'</span>, <span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> pm.HalfCauchy(<span class="st">'sigma'</span>, <span class="dv">10</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> pm.Deterministic(<span class="st">'mu'</span>, alpha <span class="op">+</span> beta <span class="op">*</span> bikes[<span class="st">'temperature'</span>].to_numpy())</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.Normal(<span class="st">'y'</span>, mu <span class="op">=</span> mu, sigma <span class="op">=</span> sigma, observed<span class="op">=</span>bikes[<span class="st">'rented'</span>].to_numpy())</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    out_ols <span class="op">=</span> pm.sample(nuts_sampler<span class="op">=</span><span class="st">'nutpie'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style>
</div>
<div class="cell-output cell-output-display">
<div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">4</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">4</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress id="total-progress-bar" max="8000" value="8000">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.70</td>
                    <td>15</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.78</td>
                    <td>7</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.72</td>
                    <td>3</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.76</td>
                    <td>7</td>
                </tr>
            
            
        </tbody>
    </table>
</div>
</div>
</div>
<section id="interpreting-model-output" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="interpreting-model-output"><span class="header-section-number">4.1.1</span> Interpreting Model output</h3>
<p>One of the strongest points of Bayesian statistics is that we can convey our uncertainty in way that is really plottable! However, this requires working with the posterior. So we can extract the posterior like this.</p>
<div id="f774d7a8" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>posterior <span class="op">=</span> az.extract(out_ols, num_samples<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>plot <span class="op">=</span> xr.DataArray(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    np.linspace(bikes[<span class="st">'temperature'</span>].<span class="bu">min</span>(), bikes[<span class="st">'temperature'</span>].<span class="bu">max</span>(), <span class="dv">50</span>) , dims <span class="op">=</span> <span class="st">'plot_id'</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>mean_lines <span class="op">=</span> posterior[<span class="st">'alpha'</span>].mean() <span class="op">+</span> posterior[<span class="st">'beta'</span>].mean() <span class="op">*</span> plot</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>lines <span class="op">=</span> posterior[<span class="st">'alpha'</span>] <span class="op">+</span> posterior[<span class="st">'beta'</span>] <span class="op">*</span> plot</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>hdi <span class="op">=</span> az.hdi(out_ols.posterior[<span class="st">'mu'</span>])</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>axes.plot(bikes[<span class="st">'temperature'</span>], bikes[<span class="st">'rented'</span>],<span class="st">'C2.'</span> ,zorder<span class="op">=-</span><span class="dv">3</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>lines_ <span class="op">=</span> axes.plot(plot, lines.T, c <span class="op">=</span> <span class="st">'C1'</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>, label <span class="op">=</span> <span class="st">'lines'</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>axes.plot(plot, mean_lines, c <span class="op">=</span> <span class="st">'C0'</span>, label <span class="op">=</span> <span class="st">'mean line'</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>plt.setp(lines_[<span class="dv">1</span>:], label <span class="op">=</span> <span class="st">"_"</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>axes.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="multiple-regression_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>These look pretty nice! for the most part the model makes very similar regression lines, which is generally a good sign.</p>
</section>
<section id="interpreting-the-posterior-predictions" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="interpreting-the-posterior-predictions"><span class="header-section-number">4.1.2</span> Interpreting the posterior predictions</h3>
<p>In general when put in front of decision maker we should be able to express what our model thinks about the future. Another important thing is that looking at what our model thinks about the future is a pretty good built in check. If it predicts things that cannot happen than it is a pretty good sign that we may need to rething our model.</p>
<div id="abe01108" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>pm.sample_posterior_predictive(out_ols, model <span class="op">=</span> model_ols, extend_inferencedata<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>mean_line <span class="op">=</span> out_ols.posterior[<span class="st">'mu'</span>].mean((<span class="st">'chain'</span>, <span class="st">'draw'</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>temperature <span class="op">=</span> np.random.normal(bikes[<span class="st">'temperature'</span>], <span class="fl">0.01</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.argsort(temperature)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(temperature.<span class="bu">min</span>(), temperature.<span class="bu">max</span>(), <span class="dv">15</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>y_prds <span class="op">=</span> out_ols.posterior_predictive[<span class="st">'y'</span>].quantile(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.03</span>, <span class="fl">0.97</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span>], dim<span class="op">=</span>[<span class="st">"chain"</span>, <span class="st">"draw"</span>]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>y_hat_bound <span class="op">=</span> <span class="bu">iter</span>(</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        PchipInterpolator(temperature[idx], y_prds[i][idx])(x)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">5</span>))</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>ax.plot(bikes[<span class="st">'temperature'</span>], bikes[<span class="st">'rented'</span>], <span class="st">"C2."</span>, zorder <span class="op">=</span> <span class="op">-</span><span class="dv">3</span>)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>ax.plot(bikes[<span class="st">'temperature'</span>][idx], mean_line[idx], c <span class="op">=</span> <span class="st">'C0'</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lb, ub <span class="kw">in</span> <span class="bu">zip</span>(y_hat_bound, y_hat_bound):</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    ax.fill_between(x, lb, ub, color<span class="op">=</span><span class="st">"C1"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [y]</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"60d0e60488f54fac9d33685b1afbea78","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="multiple-regression_files/figure-html/cell-6-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="glms" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="glms"><span class="header-section-number">4.2</span> GLMS</h2>
<p>So in the prior section we saw that we are getting negative bike rentals. Which does not make any sense. Obviously we cannot have a negative number for a count. So we are going to use a count model. We could use a fish regression or a negative binomial. One really important thing about the PyMC universe is that a bit like Stan we do have to do some extra stuff to make sure the model knows what it is doing. So lets go ahead and show this.</p>
<div id="6619b483" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> neg_model_wrong: </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> pm.Normal(<span class="st">'alpha'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> pm.Normal(<span class="st">'beta'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma'</span>, <span class="dv">10</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> pm.Deterministic(<span class="st">'mu'</span>, alpha <span class="op">+</span> beta <span class="op">*</span> bikes[<span class="st">'temperature'</span>].to_numpy())</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.NegativeBinomial(<span class="st">'y'</span>, mu <span class="op">=</span> mu, alpha <span class="op">=</span> alpha, observed <span class="op">=</span> bikes[<span class="st">'rented'</span>].to_numpy())</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    neg_wrong_out <span class="op">=</span> pm.sample()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    neg_wrong_out.extend(pm.sample_posterior_predictive(neg_wrong_out))</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>neg_model_wrong.debug()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Initializing NUTS using jitter+adapt_diag...</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">SamplingError</span>                             Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[6]</span><span class="ansi-green-fg">, line 7</span>
<span class="ansi-green-fg">      5</span>     mu = pm.Deterministic(<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">mu</span><span class="ansi-yellow-fg">'</span>, alpha + beta * bikes[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">temperature</span><span class="ansi-yellow-fg">'</span>].to_numpy())
<span class="ansi-green-fg">      6</span>     y = pm.NegativeBinomial(<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">y</span><span class="ansi-yellow-fg">'</span>, mu = mu, alpha = alpha, observed = bikes[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">rented</span><span class="ansi-yellow-fg">'</span>].to_numpy())
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">7</span>     neg_wrong_out = <span class="ansi-yellow-bg">pm</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">sample</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">      8</span>     neg_wrong_out.extend(pm.sample_posterior_predictive(neg_wrong_out))
<span class="ansi-green-fg">     10</span> neg_model_wrong.debug()

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Library/CloudStorage/Dropbox/learning-bayes/bayesian-analysis-with-python/.venv/lib/python3.13/site-packages/pymc/sampling/mcmc.py:825</span>, in <span class="ansi-cyan-fg">sample</span><span class="ansi-blue-fg">(draws, tune, chains, cores, random_seed, progressbar, progressbar_theme, step, var_names, nuts_sampler, initvals, init, jitter_max_retries, n_init, trace, discard_tuned_samples, compute_convergence_checks, keep_warning_stat, return_inferencedata, idata_kwargs, nuts_sampler_kwargs, callback, mp_ctx, blas_cores, model, compile_kwargs, **kwargs)</span>
<span class="ansi-green-fg">    823</span>         [kwargs.setdefault(k, v) <span style="font-weight:bold;color:rgb(0,135,0)">for</span> k, v <span style="font-weight:bold;color:rgb(175,0,255)">in</span> nuts_kwargs.items()]
<span class="ansi-green-fg">    824</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> joined_blas_limiter():
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">825</span>         initial_points, step = <span class="ansi-yellow-bg">init_nuts</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    826</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">init</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">init</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    827</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">chains</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">chains</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    828</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">n_init</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">n_init</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    829</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    830</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">random_seed</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">random_seed_list</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    831</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">progressbar</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">progress_bool</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    832</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">jitter_max_retries</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">jitter_max_retries</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    833</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">tune</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">tune</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    834</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">initvals</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">initvals</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    835</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">compile_kwargs</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">compile_kwargs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    836</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    837</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    838</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">    839</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Get initial points</span>
<span class="ansi-green-fg">    840</span>     ipfns = make_initial_point_fns_per_chain(
<span class="ansi-green-fg">    841</span>         model=model,
<span class="ansi-green-fg">    842</span>         overrides=initvals,
<span class="ansi-green-fg">    843</span>         jitter_rvs=<span style="color:rgb(0,135,0)">set</span>(),
<span class="ansi-green-fg">    844</span>         chains=chains,
<span class="ansi-green-fg">    845</span>     )

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Library/CloudStorage/Dropbox/learning-bayes/bayesian-analysis-with-python/.venv/lib/python3.13/site-packages/pymc/sampling/mcmc.py:1598</span>, in <span class="ansi-cyan-fg">init_nuts</span><span class="ansi-blue-fg">(init, chains, n_init, model, random_seed, progressbar, jitter_max_retries, tune, initvals, compile_kwargs, **kwargs)</span>
<span class="ansi-green-fg">   1595</span>     q, _ = DictToArrayBijection.map(ip)
<span class="ansi-green-fg">   1596</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> logp_dlogp_func([q], extra_vars={})[<span class="ansi-green-fg">0</span>]
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1598</span> initial_points = <span class="ansi-yellow-bg">_init_jitter</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">   1599</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1600</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">initvals</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1601</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">seeds</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">random_seed_list</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1602</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">jitter</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">jitter</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(175,0,255)" class="ansi-yellow-bg">in</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">init</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1603</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">jitter_max_retries</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">jitter_max_retries</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1604</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">logp_fn</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">model_logp_fn</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1605</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">   1607</span> apoints = [DictToArrayBijection.map(point) <span style="font-weight:bold;color:rgb(0,135,0)">for</span> point <span style="font-weight:bold;color:rgb(175,0,255)">in</span> initial_points]
<span class="ansi-green-fg">   1608</span> apoints_data = [apoint.data <span style="font-weight:bold;color:rgb(0,135,0)">for</span> apoint <span style="font-weight:bold;color:rgb(175,0,255)">in</span> apoints]

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Library/CloudStorage/Dropbox/learning-bayes/bayesian-analysis-with-python/.venv/lib/python3.13/site-packages/pymc/sampling/mcmc.py:1479</span>, in <span class="ansi-cyan-fg">_init_jitter</span><span class="ansi-blue-fg">(model, initvals, seeds, jitter, jitter_max_retries, logp_fn)</span>
<span class="ansi-green-fg">   1476</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> np.isfinite(point_logp):
<span class="ansi-green-fg">   1477</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> i == jitter_max_retries:
<span class="ansi-green-fg">   1478</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Print informative message on last attempted point</span>
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1479</span>         <span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">check_start_vals</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">point</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">   1480</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Retry with a new seed</span>
<span class="ansi-green-fg">   1481</span>     seed = rng.integers(<span class="ansi-green-fg">2</span>**<span class="ansi-green-fg">30</span>, dtype=np.int64)

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/Library/CloudStorage/Dropbox/learning-bayes/bayesian-analysis-with-python/.venv/lib/python3.13/site-packages/pymc/model/core.py:1761</span>, in <span class="ansi-cyan-fg">Model.check_start_vals</span><span class="ansi-blue-fg">(self, start, **kwargs)</span>
<span class="ansi-green-fg">   1758</span> initial_eval = <span style="color:rgb(0,135,0)">self</span>.point_logps(point=elem, **kwargs)
<span class="ansi-green-fg">   1760</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">all</span>(np.isfinite(v) <span style="font-weight:bold;color:rgb(0,135,0)">for</span> v <span style="font-weight:bold;color:rgb(175,0,255)">in</span> initial_eval.values()):
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1761</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> SamplingError(
<span class="ansi-green-fg">   1762</span>         <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Initial evaluation of model at starting point failed!</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">   1763</span>         <span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Starting values:</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>elem<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">   1764</span>         <span class="ansi-yellow-fg">f</span><span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">Logp initial evaluation results:</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>initial_eval<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">   1765</span>         <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">You can call `model.debug()` for more details.</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">   1766</span>     )

<span class="ansi-red-fg">SamplingError</span>: Initial evaluation of model at starting point failed!
Starting values:
{'alpha': array(-0.38690733), 'beta': array(-0.74528227), 'sigma_log__': array(2.16074549)}

Logp initial evaluation results:
{'alpha': np.float64(-0.99), 'beta': np.float64(-3.22), 'sigma': np.float64(-0.74), 'y': np.float64(-inf)}
You can call `model.debug()` for more details.</pre>
</div>
</div>
</div>
<p>It looks like the model will actually get supermad and not let you do that. Which is good lol it is probably good that there are some built in checks with the software as well as the fact that the NUTS sampler is probably having a hard time exploring the posterior distribution.</p>
<div id="7ddcbb82" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> neg_model_good:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> pm.Normal(<span class="st">'alpha'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> pm.Normal(<span class="st">'beta'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma'</span>, <span class="dv">10</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> pm.Deterministic(<span class="st">'mu'</span>, pm.math.exp(alpha <span class="op">+</span> beta <span class="op">*</span> bikes[<span class="st">'temperature'</span>].to_numpy()))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.NegativeBinomial(<span class="st">'y'</span>, mu <span class="op">=</span> mu, alpha <span class="op">=</span> sigma, observed <span class="op">=</span> bikes[<span class="st">'rented'</span>].to_numpy())</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    neg_good_out <span class="op">=</span> pm.sample(nuts_sampler<span class="op">=</span><span class="st">'nutpie'</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    neg_good_out.extend(pm.sample_posterior_predictive(neg_good_out))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style>
</div>
<div class="cell-output cell-output-display">
<div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">4</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">4</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress id="total-progress-bar" max="8000" value="8000">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.71</td>
                    <td>3</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.69</td>
                    <td>7</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.71</td>
                    <td>3</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.79</td>
                    <td>7</td>
                </tr>
            
            
        </tbody>
    </table>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling: [y]</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"07064a169db9478582e5387f25592df2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
</div>
<p>So when we go and look at the posterior predictive it is going to look like</p>
<div id="0a362db7" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>mean_line <span class="op">=</span> neg_good_out.posterior[<span class="st">'mu'</span>].mean((<span class="st">'chain'</span>, <span class="st">'draw'</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>temperature <span class="op">=</span> np.random.normal(bikes[<span class="st">'temperature'</span>].to_numpy(), <span class="fl">0.01</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.argsort(temperature)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(temperature.<span class="bu">min</span>(), temperature.<span class="bu">max</span>(), <span class="dv">15</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>y_pred_q <span class="op">=</span> neg_good_out.posterior_predictive[<span class="st">"y"</span>].quantile(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.03</span>, <span class="fl">0.97</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span>], dim<span class="op">=</span>[<span class="st">"chain"</span>, <span class="st">"draw"</span>]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>y_hat_bounds <span class="op">=</span> <span class="bu">iter</span>(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        PchipInterpolator(temperature[idx], y_pred_q[i][idx])(x)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>ax.plot(bikes[<span class="st">'temperature'</span>], bikes[<span class="st">'rented'</span>], <span class="st">"C2."</span>, zorder<span class="op">=-</span><span class="dv">3</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>ax.plot(bikes[<span class="st">'temperature'</span>][idx], mean_line[idx], c<span class="op">=</span><span class="st">"C0"</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lb, ub <span class="kw">in</span> <span class="bu">zip</span>(y_hat_bounds, y_hat_bounds):</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    ax.fill_between(x, lb, ub, color<span class="op">=</span><span class="st">"C1"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"temperature"</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"rented bikes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>Text(0, 0.5, 'rented bikes')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="multiple-regression_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="robust-regressions" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="robust-regressions"><span class="header-section-number">4.2.1</span> Robust regressions</h3>
<p>One of the nice things about <code>PyMC</code> is that we can actually start doing stuff to various parameters. So Martin uses the exmaple that he tends to not like the plain old exponential. The reason this is because the unshifted Exponential puts a lot of weight on values close to zero. Which could be fine but that is probably going to be really really data dependent. So we can do that by just passing off things to <code>pm.math</code>. So we could theoretically shift the values our self using <code>pm.math(parameter, paramater +1)</code>, but the problem is that once we pass this to the likelihood it is not going to sample the way we want it to.</p>
<div id="d1792f6e" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ans <span class="op">=</span> pl.read_csv(<span class="st">'https://raw.githubusercontent.com/aloctavodia/BAP3/refs/heads/main/code/data/anscombe_3.csv'</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> model_t:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> pm.Normal(<span class="st">'alpha'</span>, mu <span class="op">=</span> ans[<span class="st">'y'</span>].mean(), sigma <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> pm.Normal(<span class="st">'beta'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> pm.HalfNormal(<span class="st">'sigma'</span>, <span class="dv">5</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    nu <span class="op">=</span> pm.Exponential(<span class="st">'nu'</span>, <span class="dv">1</span><span class="op">/</span><span class="dv">29</span>) </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    nu_shifted <span class="op">=</span> pm.Deterministic(<span class="st">'nu_shift'</span>, nu <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> pm.Deterministic(<span class="st">'mu'</span>, alpha <span class="op">+</span> beta <span class="op">*</span> ans[<span class="st">'x'</span>].to_numpy())</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> pm.StudentT(<span class="st">'y'</span>, mu <span class="op">=</span> mu, sigma <span class="op">=</span> sigma, nu <span class="op">=</span> nu, observed<span class="op">=</span>ans[<span class="st">'y'</span>].to_numpy())</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    out_model_t <span class="op">=</span> pm.sample(<span class="dv">2000</span>, nuts_sampler<span class="op">=</span><span class="st">'nutpie'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style>
</div>
<div class="cell-output cell-output-display">
<div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">4</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">4</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress id="total-progress-bar" max="12000" value="12000">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">
            
                <tr>
                    <td class="progress-cell">
                        <progress max="3000" value="3000">
                        </progress>
                    </td>
                    <td>3000</td>
                    <td>0</td>
                    <td>0.60</td>
                    <td>7</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="3000" value="3000">
                        </progress>
                    </td>
                    <td>3000</td>
                    <td>0</td>
                    <td>0.80</td>
                    <td>7</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="3000" value="3000">
                        </progress>
                    </td>
                    <td>3000</td>
                    <td>0</td>
                    <td>0.72</td>
                    <td>7</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="3000" value="3000">
                        </progress>
                    </td>
                    <td>3000</td>
                    <td>0</td>
                    <td>0.57</td>
                    <td>3</td>
                </tr>
            
            
        </tbody>
    </table>
</div>
</div>
</div>
<p>So if we look at her compared to the non-robust version</p>
<div id="187a9676" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> linregress</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>beta_c, alpha_c, <span class="op">*</span>_ <span class="op">=</span> linregress(ans[<span class="st">'x'</span>], ans[<span class="st">'y'</span>])</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>ax.plot(ans[<span class="st">'x'</span>], (alpha_c <span class="op">+</span> beta_c <span class="op">*</span> ans[<span class="st">'x'</span>]), <span class="st">"C0:"</span>, label<span class="op">=</span><span class="st">"non-robust"</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>ax.plot(ans[<span class="st">'x'</span>], ans[<span class="st">'y'</span>], <span class="st">"C0"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>alpha_m <span class="op">=</span> out_model_t.posterior[<span class="st">"alpha"</span>].mean((<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>beta_m <span class="op">=</span> out_model_t.posterior[<span class="st">"beta"</span>].mean((<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>x_plot <span class="op">=</span> xr.DataArray(np.linspace(ans[<span class="st">'x'</span>].<span class="bu">min</span>(), ans[<span class="st">'x'</span>].<span class="bu">max</span>(), <span class="dv">50</span>), dims<span class="op">=</span><span class="st">"plot_id"</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>ax.plot(x_plot, alpha_m <span class="op">+</span> beta_m <span class="op">*</span> x_plot, c<span class="op">=</span><span class="st">"C0"</span>, label<span class="op">=</span><span class="st">"robust"</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(ans[<span class="st">'x'</span>], az.hdi(out_model_t.posterior[<span class="st">"mu"</span>])[<span class="st">"mu"</span>].T, ax<span class="op">=</span>ax)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"x"</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"y"</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/josh/Library/CloudStorage/Dropbox/learning-bayes/bayesian-analysis-with-python/.venv/lib/python3.13/site-packages/arviz/plots/hdiplot.py:166: FutureWarning: hdi currently interprets 2d data as (draw, shape) but this will change in a future release to (chain, draw) for coherence with other functions
  hdi_data = hdi(y, hdi_prob=hdi_prob, circular=circular, multimodal=False, **hdi_kwargs)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="multiple-regression_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="logits" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="logits"><span class="header-section-number">4.2.2</span> Logits</h3>
<p>A Bayesian classifier. So lets see the centering and scaling in action</p>
<div id="369612c5" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>iris <span class="op">=</span> pl.read_csv(<span class="st">'https://raw.githubusercontent.com/aloctavodia/BAP3/refs/heads/main/code/data/iris.csv'</span>).<span class="bu">filter</span>(pl.col(<span class="st">'sepal_length'</span>).is_not_nan())</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>cleanish <span class="op">=</span> iris.<span class="bu">filter</span>(pl.col(<span class="st">'species'</span>).is_in([<span class="st">'setosa'</span>, <span class="st">'versicolor'</span>])).with_columns(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    (pl.col(<span class="st">'sepal_length'</span>)<span class="op">-</span>pl.col(<span class="st">'sepal_length'</span>).mean()).alias(<span class="st">'centered'</span>),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>y_0 <span class="op">=</span> cleanish[<span class="st">'species'</span>].cast(pl.Categorical).to_physical().to_numpy()</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>x_n <span class="op">=</span> cleanish[<span class="st">'sepal_length'</span>]</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>x_c <span class="op">=</span> cleanish[<span class="st">'centered'</span>].to_numpy()</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>x_0 <span class="op">=</span> cleanish[<span class="st">'sepal_length'</span>]</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model() <span class="im">as</span> logit:</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> pm.Normal(<span class="st">'alpha'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma<span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    beta <span class="op">=</span> pm.Normal(<span class="st">'beta'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma <span class="op">=</span> <span class="dv">5</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> alpha <span class="op">+</span> x_c <span class="op">*</span> beta</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> pm.Deterministic(<span class="st">'theta'</span>, pm.math.sigmoid(mu))</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    bd <span class="op">=</span> pm.Deterministic(<span class="st">'bd'</span>, <span class="op">-</span>alpha<span class="op">/</span>beta)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    yl <span class="op">=</span> pm.Bernoulli(<span class="st">'y'</span>, p <span class="op">=</span> theta, observed <span class="op">=</span> y_0)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    out_logit <span class="op">=</span> pm.sample(nuts_sampler<span class="op">=</span><span class="st">'nutpie'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style>
</div>
<div class="cell-output cell-output-display">
<div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">4</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">4</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress id="total-progress-bar" max="8000" value="8000">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>1.04</td>
                    <td>3</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>1.10</td>
                    <td>3</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>1.09</td>
                    <td>3</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>1.06</td>
                    <td>3</td>
                </tr>
            
            
        </tbody>
    </table>
</div>
</div>
</div>
<p>Now lets see how well this matches the book</p>
<div id="1b0d509d" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>posterior <span class="op">=</span> out_logit.posterior</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> posterior[<span class="st">"theta"</span>].mean((<span class="st">"chain"</span>, <span class="st">"draw"</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> np.argsort(x_c)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>_, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>ax.plot(x_c[idx], theta[idx], color<span class="op">=</span><span class="st">"C0"</span>, lw<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>ax.vlines(posterior[<span class="st">"bd"</span>].mean((<span class="st">"chain"</span>, <span class="st">"draw"</span>)), <span class="dv">0</span>, <span class="dv">1</span>, color<span class="op">=</span><span class="st">"C2"</span>, zorder<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>bd_hdi <span class="op">=</span> az.hdi(posterior[<span class="st">"bd"</span>])</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>ax.fill_betweenx([<span class="dv">0</span>, <span class="dv">1</span>], bd_hdi[<span class="st">"bd"</span>][<span class="dv">0</span>], bd_hdi[<span class="st">"bd"</span>][<span class="dv">1</span>], color<span class="op">=</span><span class="st">"C2"</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, lw<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>ax.scatter(x_c, np.random.normal(y_0, <span class="fl">0.02</span>), marker<span class="op">=</span><span class="st">"."</span>, color<span class="op">=</span>[<span class="ss">f"C</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> x <span class="kw">in</span> y_0])</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>az.plot_hdi(x_c, posterior[<span class="st">"theta"</span>], color<span class="op">=</span><span class="st">"C0"</span>, ax<span class="op">=</span>ax, fill_kwargs<span class="op">=</span>{<span class="st">"lw"</span>: <span class="dv">0</span>})</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(x_n)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"theta"</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co"># # use original scale for xticks</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>locs, _ <span class="op">=</span> plt.xticks()</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(locs, np.<span class="bu">round</span>(locs <span class="op">+</span> x_0.mean(), <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/josh/Library/CloudStorage/Dropbox/learning-bayes/bayesian-analysis-with-python/.venv/lib/python3.13/site-packages/IPython/core/events.py:82: UserWarning: Glyph 9 (  ) missing from font(s) DejaVu Sans.
  func(*args, **kwargs)
/Users/josh/Library/CloudStorage/Dropbox/learning-bayes/bayesian-analysis-with-python/.venv/lib/python3.13/site-packages/IPython/core/pylabtools.py:170: UserWarning: Glyph 9 ( ) missing from font(s) DejaVu Sans.
  fig.canvas.print_figure(bytes_io, **kw)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="multiple-regression_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="variable-variance" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="variable-variance"><span class="header-section-number">4.3</span> Variable variance</h2>
<p>What happens when we are presented with a good old fashion problem of what happens when we violate one of our many assumptions of OLS how do we fix that? Well in some respects the most straightforward answer is to change how we specify the model. Whether this is moving from a static regression to a time-series model or incorporating group structures. Sometimes making a more complex model is not neccessarily worth it when we can just fix it with a transformation or robust standard errors. If we examine the data from the WHO.</p>
<div id="a83893d7" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> pn </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>babies_who <span class="op">=</span> pl.read_csv(<span class="st">'https://raw.githubusercontent.com/aloctavodia/BAP3/refs/heads/main/code/data/babies.csv'</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>bb_plt <span class="op">=</span> (pn.ggplot(babies_who, pn.aes(x <span class="op">=</span> <span class="st">'month'</span>, y <span class="op">=</span> <span class="st">'length'</span>)) <span class="op">+</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>       pn.geom_point() <span class="op">+</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>       pn.theme_minimal())</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>bb_plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="multiple-regression_files/figure-html/cell-14-output-1.png" width="678" height="486" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>I think for the most part we would be comfortable just fitting a polynomial and calling it a day. In R or in bambi this is a fairly easy process. In PyMC, to be fair, this is also easy but it looks a bit different. So the thing is that in the book they have <code>pm.MutableData</code> which because Python is a bit more aggressive with how things get deprecated no longer works. In part one of the good things is that now all data containers are mutable so there is now no need to have a specialized container.</p>
<div id="fdab8c3b" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pm.Model(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#coords = {'obs_idx':np.arange(len(babies_who)), "parameter": ['intercept', 'slope']}</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    ) <span class="im">as</span> model_babies:</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        x_shared <span class="op">=</span> pm.Data(<span class="st">"x_shared"</span>, babies_who[<span class="st">'month'</span>].cast(pl.Float64).to_numpy())</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> pm.Normal(<span class="st">'alpha'</span>, sigma <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        beta <span class="op">=</span> pm.Normal(<span class="st">'beta'</span>, sigma <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        gamma <span class="op">=</span> pm.HalfNormal(<span class="st">'gamma'</span>, sigma <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        delta <span class="op">=</span> pm.HalfNormal(<span class="st">'delta'</span>, sigma <span class="op">=</span> <span class="dv">10</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> pm.Deterministic(<span class="st">'mu'</span>, alpha <span class="op">+</span> beta <span class="op">*</span> x_shared<span class="op">**</span><span class="fl">0.5</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> pm.Deterministic(<span class="st">'sigma'</span>, gamma <span class="op">+</span> delta <span class="op">*</span> x_shared)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> pm.Normal(<span class="st">'y'</span>, mu <span class="op">=</span> mu, sigma <span class="op">=</span> sigma, observed <span class="op">=</span> babies_who[<span class="st">'length'</span>].to_numpy())</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        out_babies <span class="op">=</span> pm.sample(nuts_sampler<span class="op">=</span><span class="st">'nutpie'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    :root {
        --column-width-1: 40%; /* Progress column width */
        --column-width-2: 15%; /* Chain column width */
        --column-width-3: 15%; /* Divergences column width */
        --column-width-4: 15%; /* Step Size column width */
        --column-width-5: 15%; /* Gradients/Draw column width */
    }

    .nutpie {
        max-width: 800px;
        margin: 10px auto;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        //color: #333;
        //background-color: #fff;
        padding: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        font-size: 14px; /* Smaller font size for a more compact look */
    }
    .nutpie table {
        width: 100%;
        border-collapse: collapse; /* Remove any extra space between borders */
    }
    .nutpie th, .nutpie td {
        padding: 8px 10px; /* Reduce padding to make table more compact */
        text-align: left;
        border-bottom: 1px solid #888;
    }
    .nutpie th {
        //background-color: #f0f0f0;
    }

    .nutpie th:nth-child(1) { width: var(--column-width-1); }
    .nutpie th:nth-child(2) { width: var(--column-width-2); }
    .nutpie th:nth-child(3) { width: var(--column-width-3); }
    .nutpie th:nth-child(4) { width: var(--column-width-4); }
    .nutpie th:nth-child(5) { width: var(--column-width-5); }

    .nutpie progress {
        width: 100%;
        height: 15px; /* Smaller progress bars */
        border-radius: 5px;
    }
    progress::-webkit-progress-bar {
        background-color: #eee;
        border-radius: 5px;
    }
    progress::-webkit-progress-value {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    progress::-moz-progress-bar {
        background-color: #5cb85c;
        border-radius: 5px;
    }
    .nutpie .progress-cell {
        width: 100%;
    }

    .nutpie p strong { font-size: 16px; font-weight: bold; }

    @media (prefers-color-scheme: dark) {
        .nutpie {
            //color: #ddd;
            //background-color: #1e1e1e;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nutpie table, .nutpie th, .nutpie td {
            border-color: #555;
            color: #ccc;
        }
        .nutpie th {
            background-color: #2a2a2a;
        }
        .nutpie progress::-webkit-progress-bar {
            background-color: #444;
        }
        .nutpie progress::-webkit-progress-value {
            background-color: #3178c6;
        }
        .nutpie progress::-moz-progress-bar {
            background-color: #3178c6;
        }
    }
</style>
</div>
<div class="cell-output cell-output-display">
<div class="nutpie">
    <p><strong>Sampler Progress</strong></p>
    <p>Total Chains: <span id="total-chains">4</span></p>
    <p>Active Chains: <span id="active-chains">0</span></p>
    <p>
        Finished Chains:
        <span id="active-chains">4</span>
    </p>
    <p>Sampling for now</p>
    <p>
        Estimated Time to Completion:
        <span id="eta">now</span>
    </p>

    <progress id="total-progress-bar" max="8000" value="8000">
    </progress>
    <table>
        <thead>
            <tr>
                <th>Progress</th>
                <th>Draws</th>
                <th>Divergences</th>
                <th>Step Size</th>
                <th>Gradients/Draw</th>
            </tr>
        </thead>
        <tbody id="chain-details">
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.68</td>
                    <td>3</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.67</td>
                    <td>7</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.66</td>
                    <td>7</td>
                </tr>
            
                <tr>
                    <td class="progress-cell">
                        <progress max="2000" value="2000">
                        </progress>
                    </td>
                    <td>2000</td>
                    <td>0</td>
                    <td>0.67</td>
                    <td>3</td>
                </tr>
            
            
        </tbody>
    </table>
</div>
</div>
</div>
<p>Okay now lets see how good this worked. For the most part this looks more or less like the</p>
<div id="60319137" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>_, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>,<span class="dv">2</span>, figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">4</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(babies_who[<span class="st">'month'</span>], babies_who[<span class="st">'length'</span>], <span class="st">'C0.'</span>, alpha <span class="op">=</span> <span class="fl">0.1</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>posterior <span class="op">=</span> az.extract(out_babies)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>mu_m <span class="op">=</span> posterior[<span class="st">'mu'</span>].mean(<span class="st">'sample'</span>).values</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>sigma_m <span class="op">=</span> posterior[<span class="st">'sigma'</span>].mean(<span class="st">'sample'</span>).values</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(babies_who[<span class="st">'month'</span>], mu_m, c <span class="op">=</span> <span class="st">'k'</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].fill_between(babies_who[<span class="st">'month'</span>], mu_m <span class="op">+</span> <span class="dv">1</span> <span class="op">*</span> sigma_m, mu_m <span class="op">-</span> <span class="dv">1</span> <span class="op">*</span> sigma_m, alpha<span class="op">=</span><span class="fl">0.6</span>, color<span class="op">=</span><span class="st">"C1"</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].fill_between(babies_who[<span class="st">'month'</span>], mu_m <span class="op">+</span> <span class="dv">2</span> <span class="op">*</span> sigma_m, mu_m <span class="op">-</span> <span class="dv">2</span> <span class="op">*</span> sigma_m, alpha<span class="op">=</span><span class="fl">0.4</span>, color<span class="op">=</span><span class="st">"C1"</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'months'</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'length'</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(babies_who[<span class="st">'month'</span>], sigma_m)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"months"</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="vs">r"</span><span class="dv">$\b</span><span class="vs">ar </span><span class="dv">\s</span><span class="vs">igma</span><span class="dv">$</span><span class="vs">"</span>, rotation<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>Text(0, 0.5, '$\\bar \\sigma$')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="multiple-regression_files/figure-html/cell-16-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="hmlm" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="hmlm"><span class="header-section-number">4.4</span> HMLM</h2>
<p>We did some of the bare bones of builiding MLM’s in the prior chapter but in practice they are a bit more complicated than what we were dealing with in the prior</p>


</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{"07064a169db9478582e5387f25592df2":{"model_module":"@jupyter-widgets/output","model_module_version":"1.0.0","model_name":"OutputModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/output","_model_module_version":"1.0.0","_model_name":"OutputModel","_view_count":null,"_view_module":"@jupyter-widgets/output","_view_module_version":"1.0.0","_view_name":"OutputView","layout":"IPY_MODEL_29b9257ac0d242de9b7f6ad4314fa08a","msg_id":"","outputs":[{"data":{"text/html":"<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Sampling ... <span style=\"color: #008000; text-decoration-color: #008000\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span style=\"color: #800080; text-decoration-color: #800080\">100%</span> 0:00:00 / 0:00:00\n</pre>\n","text/plain":"Sampling ... \u001b[32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[35m100%\u001b[0m 0:00:00 / 0:00:00\n"},"metadata":{},"output_type":"display_data"}],"tabbable":null,"tooltip":null}},"29b9257ac0d242de9b7f6ad4314fa08a":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"60d0e60488f54fac9d33685b1afbea78":{"model_module":"@jupyter-widgets/output","model_module_version":"1.0.0","model_name":"OutputModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/output","_model_module_version":"1.0.0","_model_name":"OutputModel","_view_count":null,"_view_module":"@jupyter-widgets/output","_view_module_version":"1.0.0","_view_name":"OutputView","layout":"IPY_MODEL_7bf6ac510fd646a3acd5a29d96e4ed02","msg_id":"","outputs":[{"data":{"text/html":"<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Sampling ... <span style=\"color: #008000; text-decoration-color: #008000\">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span style=\"color: #800080; text-decoration-color: #800080\">100%</span> 0:00:00 / 0:00:00\n</pre>\n","text/plain":"Sampling ... \u001b[32m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[35m100%\u001b[0m 0:00:00 / 0:00:00\n"},"metadata":{},"output_type":"display_data"}],"tabbable":null,"tooltip":null}},"7bf6ac510fd646a3acd5a29d96e4ed02":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}}},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./mlm.html" class="pagination-link" aria-label="Hierarchical Models">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Hierarchical Models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>